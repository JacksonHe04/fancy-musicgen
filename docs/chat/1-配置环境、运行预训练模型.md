## 工作总结

### 第一阶段：解决依赖安装问题

问题：
- 安装 `requirements.txt` 时，`av==10.0.0` 编译失败
- 错误：新版 Cython（≥3.0）与 `av==10.0.0` 不兼容，类型检查导致编译错误

解决方案：
1. 创建安装脚本 `install_deps.sh`
   - 先安装兼容的 Cython（<3.0）
   - 使用 `--no-build-isolation` 安装 `av==10.0.0`，绕过构建隔离环境
   - 安装其余依赖
   - 若镜像源失败，回退到官方 PyPI

2. 修复 libstdc++ 版本问题
   - 更新 conda 环境中的 libstdc++，解决 GLIBCXX 版本不兼容

3. 安装结果
   - 安装 142 个依赖包
   - 关键包：torch 2.1.0、numpy 1.26.4、librosa 0.11.0 等

---

### 第二阶段：配置 MusicGen 运行环境

1. 安装 audiocraft
   - 以可编辑模式安装本地 audiocraft 包（`pip install -e .`）
   - 解决模块导入问题

2. 解决 T5 tokenizer 下载问题
   - 网络无法直接访问 HuggingFace
   - 在脚本中设置 HuggingFace 镜像源（`HF_ENDPOINT=https://hf-mirror.com`）
   - 成功下载 T5 tokenizer 和模型

---

### 第三阶段：修复并运行音乐生成脚本

1. 修复 `generate_music_local.py`
   - 添加 HuggingFace 镜像源配置
   - 修复文件名重复扩展名问题（`.wav.wav` → `.wav`）
   - 使用 `audio_write` 返回的实际路径

2. 成功运行
   - 使用本地模型 `/root/autodl-tmp/musicgen/local/musicgen-small`
   - 使用 CUDA 加速（NVIDIA GeForce RTX 4090）
   - 生成 3 个音频文件：
     - 欢快的钢琴音乐
     - 平静的爵士背景音乐
     - 强烈的电子音乐

---

### 创建的文件

1. `install_deps.sh` — 依赖安装脚本
   - 处理 av 包编译问题
   - 支持镜像源回退
   - 自动更新系统库

2. `INSTALL_GUIDE.md` — 安装指南文档
   - 说明问题和解决方案
   - 使用方法

3. `generate_music_local.py` — 音乐生成脚本（已优化）
   - 支持本地模型
   - 自动配置 HuggingFace 镜像
   - 生成参数可调

---

### 技术要点

1. Cython 兼容性：使用旧版 Cython 编译 av 包
2. 构建隔离绕过：`--no-build-isolation` 使用当前环境工具
3. 网络访问：配置 HuggingFace 镜像源
4. 库版本：更新 libstdc++ 解决运行时错误
5. 可编辑安装：本地开发模式安装 audiocraft

---

### 最终成果

- 所有依赖已安装
- audiocraft 环境配置完成
- 音乐生成脚本可正常运行
- 使用本地模型成功生成音乐
- 生成的文件保存在 `./output_music/` 目录

项目环境已配置完成，可使用本地模型和库生成音乐。