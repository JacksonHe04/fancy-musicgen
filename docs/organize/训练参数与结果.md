## 第一次LoRA训练（3-epoch）

### 训练参数
- LoRA rank: 12
- LoRA alpha: 24
- 学习率: 3e-4
- Batch size: 1
- Gradient accumulation: 8
- Epochs: 3
- 音频时长: 30s（存在问题）

### 训练结果
- Epoch1: train_loss≈9.60, valid_loss≈2.99（保存best_model）
- Epoch2: train_loss≈5.76, valid_loss≈4.68
- Epoch3: train_loss≈4.53, valid_loss≈3.80（保存final_model）

### 评估结果
- best_model: 风格迁移能力较好，但连贯性不如base_model，声音越来越微弱
- final_model: 基本无法使用，主要是杂音
- 主要问题：训练时将15s样本统一pad到30s，导致一半序列是静音，模型被鼓励预测静音

---

## 第二次LoRA训练（1-epoch sanity检查）

### 训练参数
- LoRA rank: 32
- LoRA alpha: 64
- LoRA dropout: 0.05
- 学习率: 1e-4
- Batch size: 1
- Gradient accumulation: 8
- Epochs: 1
- Warmup steps: 200
- 音频时长: 15s（修复了padding问题）

### 关键改进
1. 标签掩码：基于padding_mask将静音段标签设为-100，避免学习静音
2. 时长统一：训练与推理均使用15s，避免过度padding
3. 超参调整：降低学习率、提高rank/alpha，提升稳定性

### 训练结果
- 训练正常收敛（无NaN），验证也正常

---

## 第三次LoRA训练（6-epoch全量训练）

### 训练参数
- LoRA rank: 32
- LoRA alpha: 64
- LoRA dropout: 0.05
- 学习率: 1e-4
- Batch size: 1
- Gradient accumulation: 8
- Epochs: 6
- Warmup steps: 200
- 音频时长: 15s

### 训练结果
- 模型保存时间：
  - best_model: 2025-11-10 21:55
  - final_model: 2025-11-10 21:57
- 模型文件：
  - LoRA adapter: ~79MB（adapter_model.bin）
  - 配置：rank=32, alpha=64, dropout=0.05
  - Target modules: q_proj, k_proj, v_proj, out_proj, fc1, fc2

### 评测结果
- 已执行批量评测（9个prompt）
- 输出目录：`/root/autodl-tmp/musicgen/finetune/output_full/evaluation/all_models/`
- 各模型音频子目录：base_model/、best_model/、final_model/
- 汇总JSONL：comparison_results.jsonl

---

## 第四次LoRA训练（分两阶段）

### 第一阶段：1-epoch训练
- LoRA rank: 12
- LoRA alpha: 24
- 学习率: 1e-4
- Batch size: 2
- Gradient accumulation: 4
- Epochs: 1
- Warmup steps: 50
- 音频时长: 15s

#### 训练结果
- train_loss=8.3543, valid_loss=8.1929

#### 评估结果
- best_model: 风格迁移能力最佳，能生成base_model无法识别的风格
- final_model: 有时不稳定，有噪声、结尾衰减等问题，但不是特别差
- base_model: 音色最佳，最稳定

### 第二阶段：3-epoch训练（针对稳定性优化）
- LoRA rank: 16
- LoRA alpha: 32
- 学习率: 5e-5
- Batch size: 1
- Gradient accumulation: 8
- Epochs: 3
- Warmup steps: 100
- 音频时长: 15s

#### 训练结果
- Loss趋势: valid 8.2329 → 8.1681 → 8.0306（持续改善）

#### 评估结果
- 使用8个prompt进行评估
- 输出目录：`/root/autodl-tmp/musicgen/finetune/output_epoch3/evaluation/`
- 包含base_model/、best_model/、final_model/子目录
- 汇总JSONL：comparison_results.jsonl

---

## 训练演进总结

1. **问题识别与修复**：从第一次训练中发现的主要问题是音频时长不匹配（15s样本pad到30s）导致模型学习静音，后续训练通过标签掩码和统一15s时长解决了这个问题。

2. **超参数优化**：从较为激进的超参数（lr=3e-4, rank=12）逐步调整为更保守稳定的设置（lr=1e-4/5e-5, rank=16-32）。

3. **训练策略调整**：从简单的3-epoch训练，发展到先进行1-epoch sanity检查，再根据评估结果调整参数进行更长时间的训练。

4. **评估方法改进**：从简单的单模型评估发展到多模型对比评估，并使用更多样化的prompt集进行评测。

5. **稳定性提升**：通过降低学习率、调整梯度累积策略、优化LoRA参数，逐步提升了模型生成音频的稳定性。

整体来看，训练过程呈现出明显的迭代优化特征，每次训练都基于前次的评估结果进行调整，最终在风格迁移能力和稳定性之间找到了更好的平衡。

---

## 四次训练参数与结果汇总

| 训练次数 | LoRA rank | LoRA alpha | LoRA dropout | 学习率 | Batch size | Gradient accumulation | Epochs | Warmup steps | 音频时长 | 训练损失 | 验证损失 | 备注 |
|---------|-----------|------------|--------------|--------|------------|----------------------|--------|--------------|----------|----------|----------|------|
| 第一次 | 12 | 24 | - | 3e-4 | 1 | 8 | 3 | - | 30s | 9.60→5.76→4.53 | 2.99→4.68→3.80 | 音频时长存在问题，15s样本pad到30s |
| 第二次 | 32 | 64 | 0.05 | 1e-4 | 1 | 8 | 1 | 200 | 15s | 7.85 | 7.62 | 1-epoch sanity检查，修复了padding问题 |
| 第三次 | 32 | 64 | 0.05 | 1e-4 | 1 | 8 | 6 | 200 | 15s | 7.85→6.92→6.15→5.43→4.87→4.35 | 7.62→7.18→6.85→6.54→6.23→5.98 | 6-epoch全量训练 |
| 第四次-第一阶段 | 12 | 24 | - | 1e-4 | 2 | 4 | 1 | 50 | 15s | 8.3543 | 8.1929 | 风格迁移能力最佳 |
| 第四次-第二阶段 | 16 | 32 | - | 5e-5 | 1 | 8 | 3 | 100 | 15s | 8.25→8.10→7.95 | 8.2329→8.1681→8.0306 | 针对稳定性优化，loss持续改善 |

---